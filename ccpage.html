<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="UTF-8">
	<title>SimulStreaming Live Text</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<style>
		.cc-scrollbar::-webkit-scrollbar {
			width: 8px;
			background: #e0e7ef;
		}
		.cc-scrollbar::-webkit-scrollbar-thumb {
			background: #a5b4fc;
			border-radius: 6px;
		}
	</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 via-indigo-100 to-blue-200 flex items-center justify-center py-2">
	<div class="w-[95vw] max-w-[1500px] bg-white/90 rounded-3xl shadow-2xl p-2 md:p-8 border border-blue-100 relative overflow-hidden max-h-[92vh] overflow-auto">
		<div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-blue-300/40 to-indigo-400/30 rounded-full blur-2xl z-0"></div>
		<div class="absolute -bottom-10 -left-10 w-40 h-40 bg-gradient-to-tr from-indigo-200/40 to-blue-400/30 rounded-full blur-2xl z-0"></div>
		<div class="flex flex-col md:flex-row gap-6 md:gap-8 h-full z-10 relative min-h-[70vh]">
			<!-- Thông tin cuộc họp bên trái -->
			   <div class="md:w-1/4 w-full flex flex-col justify-between md:items-start items-start">
				<div>
					<h2 class="text-3xl font-extrabold text-blue-900 mb-6 text-center md:text-left tracking-wider drop-shadow-lg">Thông tin cuộc họp</h2>
					<div id="meetingInfo" class="space-y-4 mb-8">
						   <div class="bg-blue-50/60 rounded-lg px-4 py-3 shadow-sm ml-0 md:ml-0"><span class="font-semibold text-gray-700">Tên cuộc họp:</span> <span id="infoMeetingName" class="text-blue-700"></span></div>
						   <div class="bg-blue-50/60 rounded-lg px-4 py-3 shadow-sm ml-0 md:ml-0"><span class="font-semibold text-gray-700">Mã cuộc họp:</span> <span id="infoMeetingCode" class="text-blue-700"></span></div>
						   <div class="bg-blue-50/60 rounded-lg px-4 py-3 shadow-sm ml-0 md:ml-0"><span class="font-semibold text-gray-700">Chủ tọa:</span> <span id="infoHostName" class="text-blue-700"></span></div>
						   <div class="bg-blue-50/60 rounded-lg px-4 py-3 shadow-sm ml-0 md:ml-0"><span class="font-semibold text-gray-700">Thư ký:</span> <span id="infoSecretaryName" class="text-blue-700"></span></div>
					</div>
				</div>
				   <div class="mb-4 w-full">
					   <label for="micSelect" class="block font-semibold text-gray-700 mb-2">Chọn micro sử dụng:</label>
					   <select id="micSelect" class="w-full px-4 py-2 border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition bg-white text-gray-900"></select>
				   </div>
				   <div class="flex flex-row gap-3 justify-center md:justify-start mb-4 md:mb-0 flex-wrap">
					   <button id="meetingBtn" class="px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition-all duration-200 text-base tracking-wide min-w-[140px]">Bắt đầu cuộc họp</button>
					   <button id="micBtn" class="px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg transition-all duration-200 text-base tracking-wide min-w-[110px]">Bật mic</button>
					   <button id="saveDocBtn" class="px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg transition-all duration-200 text-base tracking-wide min-w-[130px] disabled:opacity-50 disabled:cursor-not-allowed" disabled>Lưu tài liệu</button>
				</div>
			</div>
			<!-- Ô textbox CC bên phải -->
			   <div class="md:w-3/4 w-full flex flex-col">
				   <textarea id="output" readonly class="cc-scrollbar w-full flex-1 min-h-[500px] h-[75vh] p-8 border-2 border-blue-300 rounded-2xl bg-white/90 text-xl font-mono text-gray-900 shadow-inner resize-none focus:outline-none focus:ring-2 focus:ring-blue-400 transition" style="max-height:90vh;"></textarea>
			</div>
		</div>
	</div>
	   <script>
		   // Lấy danh sách micro và populate vào select
		   async function loadMicrophones() {
			   if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return;
			   try {
				   const devices = await navigator.mediaDevices.enumerateDevices();
				   const micSelect = document.getElementById('micSelect');
				   micSelect.innerHTML = '';
				   
				   // Thêm option mặc định
				   const defaultOption = document.createElement('option');
				   defaultOption.value = '';
				   defaultOption.textContent = 'Select Audio Input Mic';
				   micSelect.appendChild(defaultOption);
				   
				   let found = false;
				   devices.forEach(device => {
					   if (device.kind === 'audioinput') {
						   const option = document.createElement('option');
						   option.value = device.deviceId;
						   option.textContent = device.label || `Microphone ${micSelect.length + 1}`;
						   micSelect.appendChild(option);
						   found = true;
					   }
				   });
				   if (!found) {
					   const option = document.createElement('option');
					   option.value = '';
					   option.textContent = 'Không tìm thấy micro';
					   micSelect.appendChild(option);
				   }
			   } catch (e) {
				   const micSelect = document.getElementById('micSelect');
				   micSelect.innerHTML = '<option value="">Không thể truy cập thiết bị</option>';
			   }
		   }
		   window.addEventListener('DOMContentLoaded', loadMicrophones);
		// Hiển thị thông tin cuộc họp từ localStorage
		const info = JSON.parse(localStorage.getItem('meetingInfo') || '{}');
		document.getElementById('infoMeetingName').textContent = info.meetingName || '';
		document.getElementById('infoMeetingCode').textContent = info.meetingCode || '';
		document.getElementById('infoHostName').textContent = info.hostName || '';
		document.getElementById('infoSecretaryName').textContent = info.secretaryName || '';

		const outputArea = document.getElementById('output');
		const meetingBtn = document.getElementById('meetingBtn');
		const micBtn = document.getElementById('micBtn');
		const saveDocBtn = document.getElementById('saveDocBtn');
		let ws;
		let mediaRecorder;
		let audioStream;  // Giữ stream trong suốt cuộc họp
		let meetingStarted = false;
		let micOn = false;

		function connectWebSocket() {
			ws = new WebSocket('ws://' + "127.0.0.1" + ':8765');
			ws.onmessage = function(event) {
				// Parse message: "5439 8219  Text here" -> chỉ lấy text
				let text = event.data;
				// Regex: bỏ 2 số đầu (timestamps) và lấy phần còn lại
				const match = text.match(/^\d+\s+\d+\s+(.*)$/);
				if (match) {
					text = match[1]; // Chỉ lấy phần text sau timestamps
				}
				// Loại bỏ ký tự xuống dòng nếu có
				text = text.replace(/\n/g, '').replace(/\r/g, '');
				// Nối text vào output (không xuống dòng mỗi message)
				outputArea.value += text;
				setTimeout(() => {
					outputArea.scrollTop = outputArea.scrollHeight;
				}, 10);
			};
			ws.onopen = function() {
				outputArea.value += '[Đã kết nối server]\n';
				// Gửi NEW_MEETING để clear buffer từ cuộc họp cũ
				ws.send("NEW_MEETING");
				setTimeout(() => {
					outputArea.scrollTop = outputArea.scrollHeight;
				}, 10);
			};
			ws.onclose = function() {
				outputArea.value += '[Đã ngắt kết nối server]\n';
				setTimeout(() => {
					outputArea.scrollTop = outputArea.scrollHeight;
				}, 10);
			};
		}

		async function requestMicPermission() {
			// Xin quyền mic 1 lần khi bắt đầu cuộc họp
			try {
				const selectedDeviceId = document.getElementById('micSelect').value;
				const constraints = selectedDeviceId 
					? { audio: { deviceId: { exact: selectedDeviceId } } }
					: { audio: true };
				audioStream = await navigator.mediaDevices.getUserMedia(constraints);
				return true;
			} catch (err) {
				outputArea.value += 'Lỗi truy cập micro: ' + err + '\n';
				return false;
			}
		}

		meetingBtn.onclick = async function() {
			if (!meetingStarted) {
				// Xin quyền mic trước khi bắt đầu cuộc họp
				const hasPermission = await requestMicPermission();
				if (!hasPermission) {
					outputArea.value += '[Không thể bắt đầu cuộc họp - cần quyền truy cập micro]\n';
					return;
				}
				
				// Bắt đầu cuộc họp
				connectWebSocket();
				meetingStarted = true;
				meetingBtn.textContent = 'Kết thúc cuộc họp';
				meetingBtn.classList.remove('bg-green-600','hover:bg-green-700');
				meetingBtn.classList.add('bg-red-600','hover:bg-red-700');
				outputArea.value = ''; // Clear output khi bắt đầu cuộc họp mới
				outputArea.value += '[Cuộc họp đã bắt đầu]\n';
				saveDocBtn.disabled = false; // Enable nút lưu tài liệu
			} else {
				// Kết thúc cuộc họp
				if (micOn) {
					// Tắt mic trước nếu đang bật
					stopRecording();
				}
				// Dừng audio stream
				if (audioStream) {
					audioStream.getTracks().forEach(track => track.stop());
					audioStream = null;
				}
				// Gửi signal END_MEETING để clear buffer
				if (ws && ws.readyState === WebSocket.OPEN) {
					ws.send("END_MEETING");
					// Đợi một chút để server xử lý
					await new Promise(resolve => setTimeout(resolve, 300));
					ws.close();
				}
				meetingStarted = false;
				micOn = false;
				meetingBtn.textContent = 'Bắt đầu cuộc họp';
				meetingBtn.classList.remove('bg-red-600','hover:bg-red-700');
				meetingBtn.classList.add('bg-green-600','hover:bg-green-700');
				micBtn.textContent = 'Bật mic';
				micBtn.classList.remove('bg-red-600','hover:bg-red-700');
				micBtn.classList.add('bg-blue-600','hover:bg-blue-700');
				micBtn.disabled = true;
				outputArea.value += '[Cuộc họp đã kết thúc]\n';
			}
			micBtn.disabled = !meetingStarted;
		};

		function stopRecording() {
			// Chỉ dừng MediaRecorder, KHÔNG dừng audioStream
			if (mediaRecorder && mediaRecorder.state !== 'inactive') {
				mediaRecorder.stop();
			}
			micOn = false;
			micBtn.textContent = 'Bật mic';
			micBtn.classList.remove('bg-red-600','hover:bg-red-700');
			micBtn.classList.add('bg-blue-600','hover:bg-blue-700');
			outputArea.value += '[Mic đã tắt - đang xử lý audio tồn đọng...]\n';
			setTimeout(() => {
				outputArea.scrollTop = outputArea.scrollHeight;
			}, 10);
		}

		micBtn.onclick = async function() {
			if (!meetingStarted) return;
			if (!micOn) {
				// Bật mic - sử dụng audioStream đã có
				if (!audioStream) {
					outputArea.value += '[Lỗi: Không có audio stream]\n';
					return;
				}
				
				// Gửi signal MIC_ON để đảm bảo có ffmpeg process
				if (ws && ws.readyState === WebSocket.OPEN) {
					ws.send("MIC_ON");
				}
				
				mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm' });
				mediaRecorder.ondataavailable = function(e) {
					if (ws && ws.readyState === WebSocket.OPEN) {
						ws.send(e.data);
					}
				};
				mediaRecorder.start(250); // gửi mỗi 250ms
				micOn = true;
				micBtn.textContent = 'Tắt mic';
				micBtn.classList.remove('bg-blue-600','hover:bg-blue-700');
				micBtn.classList.add('bg-red-600','hover:bg-red-700');
				outputArea.value += '[Mic đã bật]\n';
				setTimeout(() => {
					outputArea.scrollTop = outputArea.scrollHeight;
				}, 10);
			} else {
				// Tắt mic
				stopRecording();
			}
		};

		// Khởi tạo trạng thái ban đầu
		micBtn.disabled = true;

		// Xử lý lưu tài liệu
		saveDocBtn.onclick = async function() {
			const content = outputArea.value;
			if (!content || content.trim() === '') {
				alert('Không có nội dung để lưu!');
				return;
			}

			const meetingInfo = JSON.parse(localStorage.getItem('meetingInfo') || '{}');
			if (!meetingInfo.meetingCode) {
				alert('Thiếu thông tin cuộc họp!');
				return;
			}

			saveDocBtn.disabled = true;
			saveDocBtn.textContent = 'Đang lưu...';

			try {
				const response = await fetch('http://127.0.0.1:8766/save-document', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						meetingInfo: meetingInfo,
						content: content
					})
				});

				const result = await response.json();
				
				if (result.success) {
					let message = 'Đã lưu tài liệu thành công!\n';
					if (result.word) message += `\nFile WORD: ${result.word}`;
					if (result.pdf) message += `\nFile PDF: ${result.pdf}`;
					message += `\n\nThư mục: ${result.folder}`;
					alert(message);
				} else {
					alert('Lỗi khi lưu tài liệu: ' + (result.errors || []).join(', '));
				}
			} catch (error) {
				alert('Lỗi kết nối server: ' + error.message);
			} finally {
				saveDocBtn.disabled = false;
				saveDocBtn.textContent = 'Lưu tài liệu';
			}
		};
	</script>
</body>
</html>
